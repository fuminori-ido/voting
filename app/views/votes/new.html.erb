<% if current_user.already_voted?(@stage) %>
  <%= render 'voted' %>
<% else %>
  <style>
    input[disabled] + label {
      color:            #555;
      background:       #aaa;
    }

    .force-bgcolor {
      background-color: inherit;

    }
  </style>

  <% content_for :title, "New vote" %>

  <div class="md:w-2/3 w-full">
    <div class="text-center mb-4">
      <div class="text-base my-2">
        <i class="fa-solid fa-check-to-slot"></i>
        THANK YOU!
      </div>
    </div>

    <%
      rank_name_css0 = "border-t"
      rank_name_cssn = "border-t border-dashed"
    %>
    <%= form_tag(votes_path, id: 'form') do %>
      <%= hidden_field_tag('key', @stage.key) %>
      <% @stage.matches.each.with_index do |match, ix| %>
        <% if ix != 0 %>
          <div class="w-full flex justify-center my-4">
          </div>
        <% end %>
        <h2 class="font-bold text-xl border-b-4 border-indigo-600"><%= match.name %></h2>
        <% match.rank_slot.ranks.order(:name).each.with_index do |rank, ir| %>
            <% rank_name = "votes[#{match.id}][#{rank.id}]" %>
            <div class="<%= ir==0 ? rank_name_css0 : rank_name_cssn %>"><%= rank.name %></div>
            <div class="<%= %w{grid
                               grid-cols-3
                            md:grid-cols-4
                            lg:grid-cols-5
                            xl:grid-cols-6
                           2xl:grid-cols-8
                        mb-6}.join(' ') %>">
                <% for mc in match.match_candidates.joins(:candidate).order('candidates.name') do %>
                  <div>
                    <%  radio_button_name = "votes[#{match.id}][#{rank.id}][#{mc.id}]" %>
                    <%= radio_button_tag(rank_name,
                                         mc.id,
                                         data:      {match: match.id},
                                         display:   'inline',
                                         class:     "mc#{mc.id}",
                                         style:     'width: 100%',
                                         onchange:  'RadioButtonController.onchange(this);'
                        ) %>
                    <%= label_tag(radio_button_name) do %>
                      <div class="text-center  force-bgcolor">
                        <%= image_tag(big_thumb_candidate_path(mc.candidate), width: '100', class: 'mx-auto') %>
                        <%= mc.candidate.name %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
            </div>
        <% end %>
      <% end %>
      <%= submit_tag(Vote.model_name.human + 'ï¼',
                     class:     v_button_class_disabled,
                     disabled:  true) %>
    <% end %>
    <br/>
    <br/>
  </div>

  <script>
  var RadioButtonController = {
    fields: [],
    onchange(radiobutton){
      let c_          = RadioButtonController;
      let clicked_mc  = radiobutton.className;
      let match       = radiobutton.dataset.match;

      for( let rb of document.querySelectorAll('input[type="radio"]') ){
        // skip clicked radiobutton itself
        if( radiobutton.id === rb.id ){
          ;

        // skip if match is differ
        }else if( rb.dataset.match != match ){
          ;

        // same field(row)?
        }else if( rb.name == radiobutton.name ){
          // enable other radio buttons on the same field
          rb.disabled = false;

        // same column on other fields?
        }else if( rb.className == clicked_mc ){
          // reset if the same button on other fields is selected
          if( rb.checked ){
            rb.disabled = true;
            rb.checked  = false;
          }else if( !c_.is_the_field_already_selected(rb) ){
            // disable the button which is the same column on other fields
            rb.disabled = true;
            rb.checked  = false;
          }
        }else{
          // reset other buttons
          rb.disabled = false;
        }
      }
      c_.check_submit();
    },

    // private

    // is field specified by the radiobutton already selected?
    is_the_field_already_selected(radiobutton){
      for( let rb of document.getElementsByName(radiobutton.name) ){
        if( rb.checked ){
          return true;
        }
      }
      return false;
    },

    // activate/deactivate submit button based on radio buttons condition
    check_submit(){
      let c_      = RadioButtonController;
      let submit  = document.getElementsByName('commit')[0];

      if( c_.are_all_fields_selected() ){
        submit.className  = 'w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer';
        submit.disabled   = false;
      }else{
        submit.className  = 'w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium disabled:bg-gray-400';
        submit.disabled   = true;
      }
    },

    // are all fields selected?
    are_all_fields_selected(){
      let c_  = RadioButtonController;
      for( let field of c_.fields ){
        let selector = document.querySelector('input[name="' + field+ '"]:checked');
        if( selector ){
          // checked
        }else{
          return false;
        }
      }
      return true;
    }
  };
  </script>
  <script>
    RadioButtonController.fields = <%= raw(
      @stage.matches.map do |match|
        match.rank_slot.ranks.order(:name).map do |rank|
          "votes[#{match.id}][#{rank.id}]"
        end
      end.flatten.as_json
    ) %>;
  </script>
<% end %>
